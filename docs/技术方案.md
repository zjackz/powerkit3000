# PowerKit3000 技术方案

## 1. 架构概览
PowerKit3000 采用“数据导入 CLI + 领域服务 + 分析 API + 前端展示”的分层架构：

```
数据文件(JSON/JSONL) / Amazon 榜单爬取
            │
            ▼
backend/pk.consoleapp ──► AppDb (Postgres)
            │                                 │
            ▼                                 ▼
 backend/pk.core ───────► backend/pk.api ──► frontend/tradeforge-suite
        (Kickstarter + Amazon 领域服务)         (REST + Amazon 模块)        (Kickstarter / Amazon 界面)
```

- CLI 负责离线/批量导入、Amazon 快照抓取与基本运维操作。
- Core 层沉淀可复用的领域逻辑（导入、查询、统计）。
- API 层将查询与分析服务 REST 化，供前端和外部系统调用，并内联 Hangfire 定时任务。
- 前端提供运营与分析界面，支持 API 与 Mock 数据双轨运行。

## 2. 组件说明
### 2.1 CLI（`backend/pk.consoleapp`）
- 基于 Spectre.Console 构建命令体系；入口位于 `Program.cs`，命令实现置于 `Commands/` 目录。
- 核心命令：
  - `import <path>`：调用 `KickstarterDataImportService` 批量导入数据，包含批次去重、关联实体处理及日志输出。
  - `split <path> --count <n>`：拆分大文件，便于并行导入或迭代开发。
  - `query`：按多维条件查询并打印结果列表与统计摘要。
  - `counts`/`clear-db`：分别用于数据量统计与数据库清理。
  - `translate`：批量扫描缺失中文名称/简介的项目，调用翻译服务写回 `NameCn`、`BlurbCn` 字段，可配置批次、限额与 dry-run。
  - `amazon-seed`/`amazon-fetch`/`amazon-analyze`/`amazon-report`：同步 Amazon 类目、采集榜单快照、生成趋势与报告文本，形成完整抓取→分析闭环。
- 命令统一通过 `Program.RunAppAsync` 注入测试替换的 ServiceCollection，实现可测试性（见 `backend/pk.consoleapp.Tests/consoleappTests.cs`）。

### 2.2 领域服务（`backend/pk.core`）
- `KickstarterDataImportService`：解析 JSON，构建实体图，分批写入数据库，处理重复实体与异常日志。
- `KickstarterProjectQueryService`：封装查询、统计、趋势分析等方法，支持 CancellationToken，供 CLI/API 共享。
- `translations/` 模块提供 `TranslationService` 与多 Provider 接口（OpenAI、Gemini、DeepSeek、NoOp），支持批量请求、重试与内存级缓存。
- `contracts/` 定义查询参数、结果 DTO，确保上下游强类型交互，项目详情包含中英文本。
- `Amazon` 模块新增 `AmazonIngestionService`（抓取、数据入库）、`AmazonTrendAnalysisService`（趋势计算）、`AmazonReportingService`（报告生成）与 `AmazonDashboardService`（API 查询封装），基于 `HtmlAgilityPack` 抓取 Amazon 榜单并写入数据库。

### 2.3 数据层（`backend/pk.data`）
- `AppDbContext` 管理 Kickstarter 与 Amazon 双域实体，覆盖 `KickstarterProject`, `Creator`, `Category`, `Location` 及 `AmazonCategory`, `AmazonProduct`, `AmazonSnapshot`, `AmazonProductDataPoint`, `AmazonTrend`。
- 迁移管理通过 `dotnet ef` 完成；最新迁移 `AmazonModuleInit` 创建 Amazon 相关数据表与索引。
- 建议在 Postgres 上增加索引：`state`, `country`, `category_id`, `launched_at`, `percent_funded`，根据实际数据量优化。

### 2.4 分析 API（`backend/pk.api`）
- 采用 .NET Minimal API，运行时注册 DbContext 与 QueryService，并启用 Swagger/OpenAPI。
- 主要端点：
  - `GET /projects`：项目列表 + 统计。
  - `GET /filters`：状态、国家、品类选项。
  - `GET /projects/summary`：项目数量、成功数量、总筹资、覆盖国家等。
  - `GET /analytics/categories|countries|creators|top-projects|monthly-trend|funding-distribution`：多维度分析。
  - `GET /analytics/hype`：按筹资速度排序的爆款潜力榜，支持 `minPercentFunded`、`limit`。
  - `GET /analytics/category-keywords`：成品类成功项目关键词云，返回词频、项目覆盖数、平均达成率。
  - `GET /favorites` + `POST /favorites` + `DELETE /favorites/{projectId}` + `DELETE /favorites`：按客户端标识持久化收藏、备注及批量清理。
- Amazon 模块端点：
  - `POST /amazon/categories/ensure`：同步配置中的 Amazon 类目。
  - `POST /amazon/snapshots`：按类目创建榜单快照。
  - `POST /amazon/snapshots/{id}/analyze`：生成趋势标签。
  - `GET /amazon/core-metrics` / `/products` / `/trends` / `/products/{asin}/history`：提供核心指标、榜单数据、趋势列表与单品历史。
  - `GET /amazon/report/latest`：返回最新快照报告文本与趋势摘要。
- 集成 Hangfire Dashboard (`/hangfire`)，用于查看 Amazon 定时任务执行情况；生产环境须结合认证。
- 列表与高光项目返回 `NameCn`、`BlurbCn` 字段，前端可直接展示中文。
- 所有项目数据附带 `FundingVelocity`（金额/已进行天数），便于识别短期高热项目。
- 默认端口 5200，支持通过 `Cors:AllowedOrigins` 配置跨域。
- 已引入健康检查端点(`/health`)与 Serilog 结构化日志；后续计划聚焦认证中间件（Token/API Key）与速率限制。

### 2.5 前端（`frontend/tradeforge-suite`）
- 技术栈：React + TypeScript + Vite + Ant Design，状态管理采用 React Query。
- 服务层 `src/services/*` 提供 API 调用与 Mock 回退逻辑；`VITE_API_BASE_URL` 控制后端地址。
- 页签：
  - `ProjectsPage`：多条件筛选、表格、统计卡、详情抽屉。
  - `Dashboard`：筹资趋势、成功率、关键词等运营指标。
  - `Favorites`：收藏项目维护、快速筛选。
  - `AmazonPage`：展示 Amazon 核心指标、榜单产品、趋势卡片与单品历史（基于 `/amazon/*` API）。
- 错误处理：API 调用失败时尝试使用 Mock 数据并提示用户；需在后续迭代加强异常告警与埋点。

### 2.6 Hangfire 调度
- API 项目集成 `Hangfire.AspNetCore + Hangfire.PostgreSql`，任务元数据与队列存储在 Postgres。
- `AmazonJobScheduler` 启动时读取 `Amazon:EnableScheduling` 与 `Amazon:Jobs` 配置，调用 Hangfire 的 `RecurringJobManager` 注册周期性任务。
- 每个任务由 `AmazonRecurringJobService` 执行，完成“抓取 → 趋势分析”闭环；如需扩展报告推送，可在该服务内继续串联。
- `/hangfire` 仪表盘仅用于内网调试，生产发布需增加认证或代理层。

### 2.7 翻译服务架构
- 通过 `TranslationOptions` 读取默认 Provider、目标语言、批量大小、重试次数及各 Provider 凭据。
- `ITranslationProvider` 实现负责实际 API 对接，支持按需扩展；默认提供 OpenAI、Gemini、DeepSeek、NoOp 实现（后两者待补充具体调用）。
- `TranslationService` 处理去重、缓存与退避重试策略，调用失败会记录日志并重试，超出阈值后返回失败状态。
- CLI `translate` 命令基于分页扫描数据库，支持 dry-run 预览、不落库模式以验证翻译质量。

## 3. 数据流与处理逻辑
1. CLI 读取 JSON/JSONL，构建 `KickstarterProject` 对象集合。
2. 导入服务按批次去重并写入数据库，记录重复/失败项。
3. 查询服务使用 LINQ 及 EF Core 聚合，生成列表与统计数据。
4. API 将查询结果转换为 DTO，通过 REST 返回。
5. 前端调用 API，展示列表、指标卡与后续可视化图表。

## 4. 配置与部署
- **数据库连接**：`ConnectionStrings:AppDb`，可被环境变量 `ConnectionStrings__AppDb` 覆盖；不同组件共用配置。
- **迁移执行**：在 `backend/pk.data` 运行 `dotnet ef database update`；添加迁移时使用 `dotnet ef migrations add <Name>`。
- **脚本**：`scripts/run-console.sh` 自动执行 restore + run；可接入 CI/CD。
- **环境区分**：建议使用 `.env` 或 User Secrets 按环境存储连接串与 CORS 配置。
- **翻译配置**：`Translation` 节点通过环境变量覆盖（例如 `Translation__Providers__openai__ApiKey`）；未配置时默认 `noop` 返回原文。
- **Amazon 模块配置**：`Amazon` 节点定义类目列表、抓取节流(User-Agent、延迟)，可用环境变量 `Amazon__Categories__0__AmazonCategoryId` 等覆盖；抓取命令/API 调用前需确保类目已同步。
- **部署建议**：
  - 后端：Docker 镜像或系统服务托管，配置健康检查与日志收集。
  - 前端：Vite 构建后静态部署（如 Nginx/S3 + CloudFront），通过环境变量注入 API 地址。

## 5. 监控与运维（规划）
- 导入命令：输出结构化日志（JSON），记录批次、文件名、成功/失败数量；建议推送至集中日志平台。
- API：集成 ASP.NET Core 健康检查、请求日志与 APM（如 Application Insights）。
- 数据：每日导入成功率、项目总量、异常记录需纳入监控仪表盘。
- 翻译：记录调用成功率、失败原因、平均耗时及配额使用，必要时告警；建议缓存已翻译文本以降低成本。

## 6. 测试策略
- 单元测试：`backend/pk.consoleapp.Tests` 使用内存数据库验证 CLI 行为；后续需为 QueryService 与 API 补充测试。
- 集成测试：计划引入 WebApplicationFactory 验证 API 契约；前端可采用 Playwright/Cypress 进行冒烟测试。
- 数据校验：导入前可加入 Schema 校验或 JSON Schema 校正。
- 注释校验：提交前必须运行 `scripts/validate-chinese-comments.sh`，确保所有新增/修改的 `.cs`、`.ts`、`.tsx`、`.js` 文件包含语义明确的中文注释。

## 7. 安全与合规
- 短期内依赖内部网络；上线前需实现身份认证、访问审计与敏感字段脱敏。
- Kickstarter 数据使用许可需评估，必要时对导出的报表进行脱敏处理。

## 8. 文档与协作
- 技术变更同步更新本文件及 README 快速上手章节。
- 需求与进度变化写入 `docs/需求文档.md`、`docs/工程进度.md`，确保跨职能对齐。
- 建议建立“需求 → 方案 → 开发 → 验收”清单模板，迭代结束前核对是否补齐测试、文档与部署说明。

本方案将随迭代持续更新，若新增组件或外部依赖，请在对应章节补充。EOF

# PowerKit3000 技术方案

> 阅读顺序建议：先通读 [`docs/需求文档.md`](需求文档.md) 获取范围与验收，再回到本方案确认分层职责；涉及业务规划的延伸背景位于 [`docs/产品规划.md`](产品规划.md)。

## 维护提示
- 架构变更、组件新增或跨团队依赖发生调整时，24 小时内更新对应章节，并在“关键技术点”下追加版本历史。
- 若与 `docs/工程进度.md` 中的里程碑存在差异，请同步校验并备注变更原因。
- 技术债务或待验证方案，应在各模块小节末尾添加“开放问题”列表，避免遗漏。

## 1. 架构概览
PowerKit3000 采用“数据导入 CLI + 领域服务 + 分析 API + 前端展示”的分层架构：

```
数据文件(JSON/JSONL) / Amazon 榜单爬取
            │
            ▼
backend/pk.consoleapp ──► AppDb (Postgres)
            │                                 │
            ▼                                 ▼
 backend/pk.core ───────► backend/pk.api ──► frontend/tradeforge-suite
        (Kickstarter + Amazon 领域服务)         (REST + Amazon 模块)        (Kickstarter / Amazon 界面)
```

- CLI 负责离线/批量导入、Amazon 快照抓取与基本运维操作。
- Core 层沉淀可复用的领域逻辑（导入、查询、统计）。
- API 层将查询与分析服务 REST 化，供前端和外部系统调用，并内联 Hangfire 定时任务。
- 前端提供运营与分析界面，支持 API 与 Mock 数据双轨运行。

## 2. 组件说明
### 2.1 CLI（`backend/pk.consoleapp`）
- 基于 Spectre.Console 构建命令体系；入口位于 `Program.cs`，命令实现置于 `Commands/` 目录。
- 核心命令：
  - `import <path>`：调用 `KickstarterDataImportService` 批量导入数据，包含批次去重、关联实体处理及日志输出。
  - `split <path> --count <n>`：拆分大文件，便于并行导入或迭代开发。
  - `query`：按多维条件查询并打印结果列表与统计摘要。
  - `counts`/`clear-db`：分别用于数据量统计与数据库清理。
  - `translate`：批量扫描缺失中文名称/简介的项目，调用翻译服务写回 `NameCn`、`BlurbCn` 字段，可配置批次、限额与 dry-run。
  - `amazon-seed`/`amazon-fetch`/`amazon-analyze`/`amazon-report`：同步 Amazon 类目、采集榜单快照、生成趋势与报告文本，形成完整抓取→分析闭环。
  - `metrics [--url <api>] [--watch] [--interval <s>]`：拉取后端 `/monitoring/metrics` 快照，终端查看导入文件/批次计数、解析/校验错误与查询耗时；支持 watch 模式按秒刷新并展示增量，并会根据解析失败、校验失败、慢查询等指标给出终端预警（默认指向 `http://localhost:5200/monitoring/metrics`，可通过 `PK_MONITORING_BASE_URL` 自定义基地址）。
- 命令统一通过 `Program.RunAppAsync` 注入测试替换的 ServiceCollection，实现可测试性（见 `backend/pk.consoleapp.Tests/consoleappTests.cs`）。

### 2.2 领域服务（`backend/pk.core`）
- `KickstarterDataImportService`：解析 JSON，构建实体图，分批写入数据库；内置数据校验、重复检测、结构化日志与指标（导入文件、批次、跳过、解析/校验错误、耗时）。
- `KickstarterProjectQueryService`：封装查询、统计、趋势分析等方法，支持 CancellationToken，供 CLI/API 共享。
- `translations/` 模块提供 `TranslationService` 与多 Provider 接口（OpenAI、Gemini、DeepSeek、NoOp），支持批量请求、重试与内存级缓存。
- `contracts/` 定义查询参数、结果 DTO，确保上下游强类型交互，项目详情包含中英文本。
- `Amazon` 模块新增 `AmazonIngestionService`（抓取、数据入库）、`AmazonTrendAnalysisService`（趋势计算）、`AmazonReportingService`（报告生成）与 `AmazonDashboardService`（API 查询封装），基于 `HtmlAgilityPack` 抓取 Amazon 榜单并写入数据库。

### 2.3 数据层（`backend/pk.data`）
- `AppDbContext` 管理 Kickstarter 与 Amazon 双域实体，覆盖 `KickstarterProject`, `Creator`, `Category`, `Location` 及 `AmazonCategory`, `AmazonProduct`, `AmazonSnapshot`, `AmazonProductDataPoint`, `AmazonTrend`。
- 迁移管理通过 `dotnet ef` 完成；最新迁移 `AmazonModuleInit` 创建 Amazon 相关数据表与索引。
- 建议在 Postgres 上增加索引：`state`, `country`, `category_id`, `launched_at`, `percent_funded`，根据实际数据量优化。

### 2.4 分析 API（`backend/pk.api`）
- 采用 .NET Minimal API，运行时注册 DbContext 与 QueryService，并启用 Swagger/OpenAPI。
- 主要端点：
  - `GET /projects`：项目列表 + 统计。
  - `GET /filters`：状态、国家、品类选项。
  - `GET /projects/summary`：项目数量、成功数量、总筹资、覆盖国家等。
  - `GET /analytics/categories|countries|creators|top-projects|monthly-trend|funding-distribution`：多维度分析。
  - `GET /analytics/hype`：按筹资速度排序的爆款潜力榜，支持 `minPercentFunded`、`limit`。
  - `GET /analytics/category-keywords`：成品类成功项目关键词云，返回词频、项目覆盖数、平均达成率。
  - `GET /favorites` + `POST /favorites` + `DELETE /favorites/{projectId}` + `DELETE /favorites`：按客户端标识持久化收藏、备注及批量清理。
- Amazon 模块端点：
  - `POST /amazon/categories/ensure`：同步配置中的 Amazon 类目。
  - `POST /amazon/snapshots`：按类目创建榜单快照。
  - `POST /amazon/snapshots/{id}/analyze`：生成趋势标签。
  - `GET /amazon/core-metrics` / `/products` / `/trends` / `/products/{asin}/history`：提供核心指标、榜单数据、趋势列表与单品历史。
  - `GET /amazon/report/latest`：返回最新快照报告文本与趋势摘要。
- 内置 `/monitoring/metrics` 指标快照端点，通过 `MeterListener` 监听 `pk.core.metrics`，导出导入文件/批次、成功/跳过/解析/校验错误计数以及查询耗时等核心指标，并附 `LastUpdatedUtc` 字段便于看板刷新；支持按 `source`、`reason` 标签做进一步聚合，watch 模式可直接呈现 Top10 明细。
- 集成 Hangfire Dashboard (`/hangfire`)，用于查看 Amazon 定时任务执行情况；生产环境须结合认证。
- 列表与高光项目返回 `NameCn`、`BlurbCn` 字段，前端可直接展示中文。
- 所有项目数据附带 `FundingVelocity`（金额/已进行天数），便于识别短期高热项目。
- 默认端口 5200，支持通过 `Cors:AllowedOrigins` 配置跨域。
- 已引入健康检查端点(`/health`)与 Serilog 结构化日志；后续计划聚焦认证中间件（Token/API Key）与速率限制。

### 2.5 前端
- **Legacy SPA（`frontend/tradeforge-suite`）**：React + TypeScript + Vite + Ant Design，配合 React Query 管理数据请求。服务层 `src/services/*` 提供 API 调用与 Mock 回退逻辑，`VITE_API_BASE_URL` 控制后端地址；页面包含 `Dashboard`（筹资趋势、成功率、关键词、系统健康卡片）、`ProjectsPage`（多条件筛选与详情抽屉）、`Favorites`（收藏管理）与 `AmazonPage`（榜单数据与趋势可视化）。Dashboard 新增 `SystemHealthCard` 通过 `systemHealthService` 聚合 `/monitoring/metrics` 指标，轮询展示导入文件、异常计数与慢查询告警。
- **Next 代 Control Tower（`frontend/tradeforge-suite-next`）**：基于 Next.js App Router + Ant Design Pro，现已接入项目服务与 Amazon 指标 API，提供多团队 TeamSwitcher、Dashboard KPI 汇总、系统健康监控、项目巡检表格、收藏驾驶舱、Amazon 运营中控、趋势雷达与抓取调度页面；组件层复用 ProCard/StatisticCard，React Query 与自定义服务共享回退逻辑，页面默认 30 秒刷新关键指标。
- **主题与组件策略**：`src/theme/themeConfig.ts` 集中维护品牌色与组件 token，`AntdAppShell` 负责注入 ConfigProvider + React Query + CSS-in-JS StyleProvider，`ProShell` 统一页头、导航、KPI 区块与内容栅格，支持后续扩展命令面板、告警提醒等能力。
- **迁移原则**：保留旧版 SPA 直至新架构全量覆盖；新页面按域逐步迁移（Dashboard → Amazon → Projects/Favorites），并在 `docs/技术方案.md` 与 `docs/工程进度.md` 记录切换节奏及验证项。关键指标与 API 契约需同步在后端新增字段/接口时更新文档。
- **Legacy SPA 清理策略**：`frontend/tradeforge-suite` 现仅保留基础仪表盘/项目/收藏/Legacy Amazon 浏览，导航中已加入“打开新版 Control Tower”外链；通过 `VITE_CONTROL_TOWER_URL` 指向 Next.js 部署地址，默认 `http://localhost:3000`，并在页面顶部展示提示，提醒使用者迁移至新版驾驶舱。
- **待办事项**：完成 API 数据接入、Workspace 自定义看板、Amazon 趋势重构、命令面板/快捷键、指标 Builder；建立 Playwright + Storybook 回归、Lighthouse 性能阈值及发行流程（Canary/Feature Flag）。

### 2.6 Hangfire 调度
- API 项目集成 `Hangfire.AspNetCore + Hangfire.PostgreSql`，任务元数据与队列存储在 Postgres。
- `AmazonJobScheduler` 启动时读取 `Amazon:EnableScheduling` 与 `Amazon:Jobs` 配置，调用 Hangfire 的 `RecurringJobManager` 注册周期性任务。
- 每个任务由 `AmazonRecurringJobService` 执行，完成“抓取 → 趋势分析”闭环；如需扩展报告推送，可在该服务内继续串联。
- `/hangfire` 仪表盘仅用于内网调试，生产发布需增加认证或代理层。

### 2.7 翻译服务架构
- 通过 `TranslationOptions` 读取默认 Provider、目标语言、批量大小、重试次数及各 Provider 凭据。
- `ITranslationProvider` 实现负责实际 API 对接，支持按需扩展；默认提供 OpenAI、Gemini、DeepSeek、NoOp 实现（后两者待补充具体调用）。
- `TranslationService` 处理去重、缓存与退避重试策略，调用失败会记录日志并重试，超出阈值后返回失败状态。
- CLI `translate` 命令基于分页扫描数据库，支持 dry-run 预览、不落库模式以验证翻译质量。

## 3. 数据流与处理逻辑
1. CLI 读取 JSON/JSONL，构建 `KickstarterProject` 对象集合。
2. 导入服务按批次去重并写入数据库，记录重复/失败项。
3. 查询服务使用 LINQ 及 EF Core 聚合，生成列表与统计数据。
4. API 将查询结果转换为 DTO，通过 REST 返回。
5. 前端调用 API，展示列表、指标卡与后续可视化图表。

## 4. 配置与部署
- **数据库连接**：`ConnectionStrings:AppDb`，可被环境变量 `ConnectionStrings__AppDb` 覆盖；不同组件共用配置。
- **迁移执行**：在 `backend/pk.data` 运行 `dotnet ef database update`；添加迁移时使用 `dotnet ef migrations add <Name>`。
- **脚本**：`scripts/console.sh` 自动执行 restore + run；可接入 CI/CD。
- **环境区分**：建议使用 `.env` 或 User Secrets 按环境存储连接串与 CORS 配置。
- **翻译配置**：`Translation` 节点通过环境变量覆盖（例如 `Translation__Providers__openai__ApiKey`）；未配置时默认 `noop` 返回原文。
- **Amazon 模块配置**：`Amazon` 节点定义类目列表、抓取节流(User-Agent、延迟)，可用环境变量 `Amazon__Categories__0__AmazonCategoryId` 等覆盖；抓取命令/API 调用前需确保类目已同步。
- **部署建议**：
  - 后端：Docker 镜像或系统服务托管，配置健康检查与日志收集。
  - 前端：Vite 构建后静态部署（如 Nginx/S3 + CloudFront），通过环境变量注入 API 地址。

## 5. 监控与运维（规划）
- 导入命令：输出结构化日志（JSON），记录批次、文件名、成功/失败数量；建议推送至集中日志平台。
- API：集成 ASP.NET Core 健康检查、请求日志与 APM（如 Application Insights）。
- 数据：每日导入成功率、项目总量、异常记录需纳入监控仪表盘。
- 翻译：记录调用成功率、失败原因、平均耗时及配额使用，必要时告警；建议缓存已翻译文本以降低成本。

## 6. 测试策略
- 单元测试：`backend/pk.consoleapp.Tests` 使用内存数据库验证 CLI 行为；后续需为 QueryService 与 API 补充测试。
- 集成测试：计划引入 WebApplicationFactory 验证 API 契约；前端可采用 Playwright/Cypress 进行冒烟测试。
- 数据校验：导入前可加入 Schema 校验或 JSON Schema 校正。
- 注释校验：提交前必须运行 `scripts/validate-chinese-comments.sh`，确保所有新增/修改的 `.cs`、`.ts`、`.tsx`、`.js` 文件包含语义明确的中文注释。

## 7. 安全与合规
- 短期内依赖内部网络；上线前需实现身份认证、访问审计与敏感字段脱敏。
- Kickstarter 数据使用许可需评估，必要时对导出的报表进行脱敏处理。

## 8. 文档与协作
- 技术变更同步更新本文件及 README 快速上手章节。
- 需求与进度变化写入 `docs/需求文档.md`、`docs/工程进度.md`，确保跨职能对齐。
- 建议建立“需求 → 方案 → 开发 → 验收”清单模板，迭代结束前核对是否补齐测试、文档与部署说明。

本方案将随迭代持续更新，若新增组件或外部依赖，请在对应章节补充。EOF

## 8. Amazon 选品智能引擎需求与技术方案

### 8.1 目标与价值假设
- **产品愿景**：构建一个“高效发掘用户需求的选品引擎”，帮助运营/产品快速洞察 Amazon 市场热点并输出可执行方案。
- **核心价值**：以最小人工投入获取高质量候选商品，辅助选品决策；提供趋势洞察、风险提示和行动指引，形成闭环。
- **成功指标（待验证）**：
  - Top-N 候选命中率 ≥ 60%（经运营确认有进一步跟进价值）。
  - 报告生成至人工采纳的时间缩短 ≥ 40%。
  - 报表/推荐面板的日活使用人数 ≥ 5，周留存 ≥ 70%。

### 8.2 用户画像与场景
- **选品运营**：需要快速了解各类目爆款、筛选值得跟进的卖点，期望系统提供可执行指引。
- **产品经理**：关注需求趋势与市场窗口，评估是否值得孵化自有产品线。
- **数据/策略同事**：维护规则、监控质量，调优打分模型。

典型流程（三阶段）：
1. **采集配置**：在后台选择类目、价格带、地区、榜单类型、关键字，提交策略；系统反馈预计数据量和潜在风险。
2. **分析洞察**：系统自动抓取→清洗→打分，并结合历史数据生成趋势分析、主题聚合、异常提示。
3. **输出指引**：面板展示优先级列表、主题报告与推荐行动；支持交互问答、任务分派及反馈回传。

### 8.3 功能拆解
| 阶段 | 目标 | 关键能力 |
| --- | --- | --- |
| 采集 | 聚焦高价值数据，确保合规 | 类目/价格段配置、任务调度、抓取健康监控、采集预算估算、频率控制 |
| 分析 | 结构化潜力指标，自动分层 | 排行榜增量对比、评论/评分作文、关键词聚类、Cross-Source 对接（Kickstarter⇄Amazon）、异常检测 |
| 输出 | 辅助决策+闭环 | 优先级候选池、主题洞察报告、行动建议、任务化分派、反馈采集、交互问答 |

大语言模型在三个阶段的职责：
- 采集：根据配置生成风险说明、预估数据规模、建议补充筛选条件。
- 分析：对商品描述/评论摘要、主题聚类、痛点/卖点提炼、风险提示生成。
- 输出：生成周报/专题报告、推荐上下文、回答运营问题、整合反馈并优化策略提示。

### 8.4 技术方案概览
```
┌───────────┐      ┌─────────────────┐      ┌────────────────────┐
│ 采集配置 UI │◄──►│ Rule Service    │──┐   │ Scheduler/Worker   │
└───────────┘      │ (策略+预算估算) │  │   └──────┬──────────────┘
                    └─────────────────┘  │         │
                                         │         ▼
                                         │   ┌───────────┐
                                         └──►│Crawler/ETL│──┐
                                             └───────────┘  │
                                            清洗/特征      │
                                             ┌───────────┐  │
                                             │Feature Svc│◄─┘
                                             └────┬──────┘
                                                  │
                                        ┌─────────▼─────────┐
                                        │ 数据仓库 / Lakehouse│
                                        └────────┬──────────┘
                                                 │
      ┌──────────┐         ┌─────────────────┐   │   ┌────────────────┐
      │Analytics │◄────────│ Scoring Engine  │◄──┘   │ LLM Service     │
      │API (REST)│         │ + Rule Pipeline │       │ (OA/Gemini等) │
      └────┬─────┘         └─────────────────┘       └─────┬────────┘
           │                                           │
┌──────────▼────────┐                           ┌──────▼────────┐
│ 前端看板 / 选品问答 │◄───────────────────────────►│Action Orchestr.│
└───────────────────┘   报告、任务、反馈          └──────────────┘
```

### 8.5 关键技术点
1. **策略引擎与配置管理**：
   - 采用低代码形式存储任务（JSON + 版本控制），支持表单配置与 YAML 导入导出。
   - 提供预算估算器（根据历史耗时与请求量预测抓取成本），LLM 生成自然语言反馈。
2. **抓取与调度**：
   - 基于 Hangfire/Quartz 管理任务，支持分批次拉取、失败重试、结构变更报警。
   - 深度抽象 Amazon URL 规则，允许扩展其他站点；支持代理与速率控制策略。
3. **数据建模与特征工程**：
   - 构建“产品快照”事实表，包含排名、价格、评分、评论数、品牌、增长指标等。
   - 结合 Kickstarter/内部销量数据，通过 Linker 建立跨来源映射。
4. **评分与主题聚类**：
   - 统计模型：趋势分析、异常检测、竞争度计算。
   - LLM/Embedding：对标题/评论提取卖点、分类主题、识别痛点，为推荐赋予语义权重。
5. **LLM 服务**：
   - 统一封装 Provider（OpenAI、Gemini、DeepSeek），支持缓存、批量、成本追踪。
   - Prompt 模板化：采集风险提示、数据总结、主题分析、行动建议、问答。
   - 长期可探索微调或建立知识库（向量检索 + LLM 生成）。
6. **输出与协同**：
   - 前端提供优先级视图、主题雷达、任务面板。
   - 报表生成与任务推送（钉钉/飞书/Email），可选导出 CSV/Slides。
   - 用户反馈（采纳/弃用理由）回写至评分模型与 LLM 提示，形成迭代闭环。

### 8.6 里程碑规划（建议）
| 阶段 | 交付内容 | 检验点 |
| --- | --- | --- |
| M0（1-2 周） | 需求确认 + 高层设计；搭建采集配置 Demo，确认 LLM 方案与预算 | 需求评审通过，技术风险评估完成 |
| M1（3-4 周） | 采集策略引擎 + 基础抓取改造 + 数据仓库快照表；简单打分规则；初版报表 | 选定 1-2 个类目生成候选列表，运营试用 |
| M2（5-6 周） | LLM 聚类/洞察、推荐报告、任务化流程、前端看板 | 周报/看板上线，采纳率反馈进入闭环 |
| M3（6 周后） | 精细调优（多站点、异常检测、A/B 测试建议、原型实验） | 输出转化率、命中率达到 KPI |

### 8.7 风险与对策
- **页面结构变化**：建立监控，提供快速 fallback（切换备用 selector 或暂停任务），关键逻辑加自动化测试。
- **法律合规**：记录访问频率、来源；计划引入官方 API 或第三方合法数据源；配置中提示注意事项。
- **LLM 成本与稳定性**：缓存、分级调用（轻量场景用小模型，报告生成用大模型），关键流程落地前做成本测算。
- **数据质量**：加入去重、离群检测，重要字段缺失时要求人工确认；关键指标有血缘追踪。
- **团队协作**：需求、配置、模型调整需流程化（工单/审批），避免策略随意变更导致结果波动。

### 8.8 下一步行动建议
1. 与运营/Product Stakeholders 对齐 KPI、优先类目、数据覆盖范围。
2. 设计采集配置界面原型（见附录 8.A），明确可调参数与默认值，并准备示例任务。
3. 制定数据字典/特征清单（见附录 8.B），梳理需要的字段及清洗逻辑，确认数据仓库表结构。
4. 选定首批 LLM Provider（如 OpenAI GPT-4o / Gemini 1.5）与 Prompt 模板，估算费用与调用量。
5. 定义反馈与闭环流程（如何记录采纳、如何触发模型更新），确保 MVP 即可收集效果数据。

### 8.A 采集配置原型草案
目标：提供运营可配置的类目抓取策略，并即时反馈风险和预估消耗。

**界面模块**
- **任务概览**：展示任务名称（自动生成 / 自定义）、状态（草稿/待执行/执行中/完成）、最后修改人、计划下发时间。
- **基础配置**：
  - 站点/区域（默认 `amazon.com`，可选 UK/JP/DE 等）。
  - 类目选择（支持树状多选、搜索、最近使用）。
  - 榜单类型（Best Sellers / New Releases / Movers & Shakers...）。
  - 价格区间（美元，可选预设档位 + 自定义）。
  - 品牌/关键字白名单、黑名单。
  - 最低评分、最低评论数等快速过滤条件。
- **高级策略**（展开配置）：
  - 抓取频率（一次性 / 周期，每日/每周具体时间），挂钩 Hangfire 调度。
  - 请求速率与并发设置（提供建议值、提示风险）。
  - 失败重试策略（次数、间隔、退避系数）。
  - 代理/镜像策略（可选）。
  - 采集预算提示（根据历史平均耗时与请求数预测）。
- **LLM 智能建议面板**：
  - 读取当前配置生成摘要：“你将抓取 3 个类目，覆盖约 500 个商品，预计耗时 15 分钟，风险：同价位商品较多可能产生重复，建议增加关键字筛选。”
  - 若配置不合理，给出自然语言提醒（例如频率过高、抓取量超出经验上限）。
- **预览与提交**：
  - 支持运行前预览（展示预计 URL 样例、数据量估算）。
  - 可保存为模板、复制任务、导出 YAML。
  - 提交后进入审批或直接排队执行，支持状态跟踪。
- **落库方式**：
  - MVP 阶段通过 CLI 命令 `amazon-tasks seed` 写入默认任务（存于 `AmazonTasks` 表），后续可拓展 UI 或 API 维护。
  - 任务记录包含类目来源（ID/URL）、榜单类型、价格区间、过滤条件、调度与限额，均以 JSONB 存储便于动态扩展。

**数据结构草案（任务实体）**
```jsonc
{
  "id": "task_20240924_abcd",
  "name": "US 家居-新上架",
  "site": "amazon.com",
  "categories": ["Home & Kitchen > Storage"],
  "leaderboard": "NewReleases",
  "priceRange": { "min": 20, "max": 80 },
  "keywords": {
    "include": ["storage", "organizer"],
    "exclude": ["bulk", "wholesale"]
  },
  "filters": {
    "minRating": 4.2,
    "minReviews": 50
  },
  "schedule": {
    "type": "recurring",
    "cron": "0 30 2 * * *",
    "timezone": "UTC"
  },
  "limits": {
    "maxProducts": 1000,
    "maxRequestsPerHour": 500
  },
  "retries": { "maxAttempts": 3, "backoffSeconds": 30 },
  "proxyPolicy": "default",
  "llmSummary": "...",
  "status": "draft"
}
```

### 8.B 数据字典初稿（示例字段）
目标：统一抓取与分析阶段的字段口径，便于建表与特征工程。

| 表/实体 | 字段 | 描述 | 数据来源 | 备注 |
| --- | --- | --- | --- | --- |
| AmazonTask | id | 采集任务 ID | 配置中心 | 主键 |
|  | site | 站点域名 | 配置 | |
|  | categories | Amazon 类目 ID 列表 | 配置/类目表 | JSON array |
| AmazonSnapshot | id | 快照 ID | 抓取服务 | 主键 |
|  | taskId | 来源任务 | Crawler | 外键 |
|  | capturedAt | 抓取时间 | 系统 | |
| AmazonProduct | asin | 商品编号 | 抓取页面 | 主键 |
|  | title | 标题原文 | 抓取 + 清洗 | |
|  | titleSummary | 标题摘要 | LLM | 缓存 |
|  | brand | 品牌 | 抓取 | |
|  | price | 当前价格 | 抓取 | decimal |
|  | rating | 星级 | 抓取 | float |
|  | reviewsCount | 评论数 | 抓取 | int |
|  | categoryId | 类目 ID | 类目表 | 外键 |
|  | country | 市场 | 站点派生 | |
| AmazonProductDataPoint | id | 明细记录 ID | Crawler | 主键 |
|  | productAsin | ASIN | | 外键 |
|  | snapshotId | 快照 ID | | 外键 |
|  | rank | 榜单排名 | 抓取 | int |
|  | price | 价格 | 抓取 | decimal |
|  | rating | 星级 | 抓取 | float |
|  | reviewsCount | 评论 | 抓取 | int |
|  | capturedAt | 时间戳 | 系统 | |
| AmazonProductFeature | id | 特征记录 ID | Feature Service | 主键 |
|  | productAsin | ASIN | | 外键 |
|  | metrics | 指标（JSONB） | 统计 | 包含 rankDelta、priceDelta、ratingChange 等 |
|  | embeddings | 语义向量 | LLM | 存向量库 |
| AmazonTheme | id | 主题 ID | LLM 聚类 | 主键 |
|  | name | 主题名称 | LLM | 例如 "桌面收纳" |
|  | keywords | 关键词列表 | LLM | |
|  | representativeAsins | 代表商品 | 算法 | |
| Recommendation | id | 推荐 ID | Scoring Engine | 主键 |
|  | productAsin | 商品 | | 外键 |
|  | taskId | 来源任务 | | 外键 |
|  | score | 综合得分 | 算法 | float |
|  | priority | 优先级 | 算法 | enum |
|  | summary | 推荐说明 | LLM | 文本 |
|  | actionHint | 推荐动作 | LLM | 文本 |

补充说明：
- `metrics` 字段建议用 JSONB 存放动态指标（例如 `{ "rankDelta24h": -5, "reviewDelta7d": 120 }`）。
- `embeddings` 可存储向量特征，用于相似度检索；需评估存储方案（PG Vector / Pinecone / Milvus）。
- 数据字典后续需与 BI 团队确认命名规范、血缘要求，以及是否对接现有数仓。

### 8.C MVP 聚焦计划（家居 & 电动工具，30-50 美金）
目标：在 4-6 周内交付一个可用的选品引擎最小版本，服务“家居”（Home & Kitchen）与“电动工具”（Tools & Home Improvement）两个类目，聚焦价格区间 USD 30-50。

**范围确认**
- 类目：
  - Home & Kitchen（优先子类：Storage & Organization, Small Appliances）
  - Tools & Home Improvement（优先子类：Power Tools, Hand Tools）
- 榜单类型：Best Sellers + New Releases（两类即可满足增量 & 热度需求）。
- 价格区间：30-50 美元（采集阶段即做初筛）。
- 市场：先锁定 amazon.com；后续按需扩展 UK/DE。
- 调度：每日一次（UTC 02:30），输出前一天榜单增量，MVP 阶段不做实时任务。
- LLM 能力：
  - 报告摘要 + 行动建议（每日/每周）。
  - 商品卖点提炼 + 主题聚类（批量/离线）。
  - 面向运营的 QA Bot（基础版，可在看板上问“今日推荐理由？”）。

**MVP 必须交付的模块**
1. **采集配置/执行**
   - 支持上述类目、价格段的任务配置模板；提供管理界面或 JSON 配置。
   - Hangfire 调度按日执行，采集团队可监控状态。
   - 采集日志 & 健康监控：成功率、失败重试、耗时、数据量统计。
2. **数据存储与特征**
   - 建立快照、商品、数据点、指标（metrics）基础表，并按 ASIN 聚合 7/30 日趋势。
   - 预计算核心指标：rankDelta、priceDelta、reviewDelta、ratingTrend。
   - 输出 30-50 美金区间的 Top-N 排行（按照综合评分）。
3. **评分 & 推荐逻辑**
   - 初版评分功能：自定义权重（排名增速、评论增速、评分、价格稳定性）。
   - 风险标签（评分波动大、价格突升、评论异常）。
   - 主题聚类：使用 LLM（或 embedding + 聚类）生成主题标签，每日更新。
4. **LLM 输出**
   - 日度“Top Picks”摘要（含主要指标、推荐理由、风险提示）。
   - 每周“选品观察”报告（主题层面，含趋势图/亮点）。
   - 看板内嵌问答（允许运营询问推荐理由、同期竞品比较等，使用 Chat 模式 + 指定上下文）。
5. **前端/可视化**
   - 简化选品看板：展示 Top-N 列表、主题雷达、任务执行状态。
   - 支持搜索、过滤（类目/价格/标签），可快捷导出 CSV。
   - 嵌入 LLM 生成的摘要卡片 + QA 输入框。
6. **反馈机制**
   - 提供收藏/标记功能（例如“已采纳”“不考虑”），记录原因。
   - 反馈结果回写数据库，作为后续模型优化的参考。

### 5.7.1 亚马逊运营仪表盘设计草案

1. **总体目标**
    - 聚焦存量 ASIN 的运营风险，突出库存、差评、广告浪费三类问题，不追求全量指标。
    - 通过后台仪表盘提供实时可用的任务清单和趋势线索，辅助运营制定当天动作。

2. **数据来源与处理**
    - 沿用 Amazon 网页采集服务（`amazon-fetch`）获取库存、价格、评论等原始字段，采集频率维持每日至少 1 次，必要时支持手动补采集；广告位/成本暂不接入，保留接口占位以便后续扩展。
    - 在数据层新增或复用 `AmazonProductSnapshots`、`AmazonProductMetrics`，补充字段：`inventoryLevel`、`buyBoxPrice`、`reviewStar`、`reviewCount`、`latestNegativeReviewUrl` 等，确保差评链接可跳转到原文。
    - 增加 `OperationalIssue` 聚合模型（在 Core 层），每日根据最新快照计算：
        - `LowStock`：库存天数低于阈值或库存为 0；需要缓存过去 7 日销量作为分母。
        - `NegativeReview`：近 `N` 天内新增 ≤2 星评价并且评论量显著；保留评论摘要（前 200 字）。
        - `AdWaste`：广告相关指标暂未上线，本期输出占位对象（`comingSoon`），为后续接入广告数据预留结构。
    - 计算结果以 `IssueSeverity`（High/Medium/Low）标注，规则：阈值触发 + 多维度叠加（例如库存=0 ⇒ High）。

3. **后端服务设计**
    - 在 `backend/pk.core` 新增 `AmazonOperationalInsightService`：封装指标计算、严重度判定、建议语句生成；支持按店铺/站点过滤。
    - `backend/pk.api` 暴露 `/amazon/operations/issues` 端点，返回结构：
        ```json
        {
            "lastUpdatedAt": "2024-06-01T03:00:00Z",
            "issues": [
                {
                    "asin": "B08...",
                    "title": "示例商品",
                    "issueType": "LowStock",
                    "severity": "High",
                    "kpi": {
                        "inventoryDays": 5,
                        "sales7d": 30,
                        "acos": 0.35
                    },
                    "recommendation": "增加补货并压缩广告预算"
                }
            ]
        }
        ```
    - 服务需支持分页、按问题类型筛选、指标排序（如按严重度、销量影响）。
    - 记录采集更新时间：查询 Redis/数据库中的最新快照时间，若超过 48 小时需在响应中标记 `stale=true`。

4. **前端展示方案**
    - 后台仪表盘新增“运营洞察”Tab：
        - 顶部显示最后更新时间、采集状态。
        - 关键问题卡片：显示各问题类型的数量及严重程度分布。
        - 问题列表表格：列出 ASIN、问题类型、严重度、关键指标、建议动作；支持筛选和排序。
        - 抽屉详情：展示 ASIN 近 7 日销量、库存、广告投入折线图以及差评摘录。
    - 交互需求：点击“标记已处理”触发后端记录处理状态（后续迭代实现），当前阶段仅记录本地状态或提示“开发中”。

5. **配置与参数**
    - `AmazonOperationalDashboardOptions`（全局共享阈值，不区分站点/团队）：
        ```json
        {
            "InventoryThresholdDays": 10,
            "NegativeReviewWindowDays": 7,
            "AdWasteAcosThreshold": 0.3,
            "AdWasteAcosDelta": 0.05
        }
        ```
    - 配置可由 `appsettings.Company.json` 覆盖，前端通过 `/config` 接口获取默认阈值用于展示。

6. **测试策略**
    - 单元测试覆盖指标计算函数（库存天数、ACOS 判定、评论过滤）；构造边界数据验证 High/Medium/Low 分类。
    - 集成测试模拟 API 调用，确保组合过滤逻辑、分页行为与空数据占位文本正确。

7. **风险与后续工作**
    - 风险：采集字段缺失或延迟导致仪表盘呈现空状态；需增加采集失败告警。
    - 后续：结合用户反馈扩展更多问题维度（如价格战、竞争对手排名），与前述收藏/反馈机制联动形成闭环。

**阶段划分与时间预估**
| 周数 | 交付内容 | 验证目标 | 责任初步建议 |
| --- | --- | --- | --- |
| Week 1 | 需求确认、配置模板实现、采集任务跑通（手动触发） | MVP 任务能采集 30-50 USD 商品，日志可追踪 | 后端 + 采集工程 | 
| Week 2 | 数据表建模、指标计算、初版评分规则 | 生成每日 Top 20 列表（含指标） | 数据/算法 | 
| Week 3 | 运营仪表盘原型、主题聚类 Demo、前端看板原型 | 后台展示运营问题清单与 Top 列表 | AI/前端 | 
| Week 4 | 整合看板、QA Bot、反馈功能 | 运营试用，收集意见 | 全栈/产品 | 
| Week 5 | 根据反馈调优（评分权重、提示词、UI） | 推荐命中率与操作顺畅度达到预期 | 全体 | 
| Week 6 | 自验+上线准备（监控、文档、培训） | 发布 MVP，安排回顾会议 | 全体 |

**开发风险 & 缓解策略（MVP 对齐版）**
- Amazon 页面变动：在 MVP 期间设置 Selector 监控，每日对比 DOM 结构；准备冗余 Selector。
- 数据量控制：30-50 美金区间可控；设置采集自检（日新增超过预估时通知调整配置）。
- LLM 成本：MVP 先使用单模型（如 GPT-4o mini），每日限制调用次数，输出缓存到数据库。
- 团队协作：建立每周例会，跟踪任务板（Week-based），确保 UI/算法/后端同步推进。

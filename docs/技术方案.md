# PowerKit3000 技术方案

## 1. 架构概览
PowerKit3000 采用“数据导入 CLI + 领域服务 + 分析 API + 前端展示”的分层架构：

```
数据文件(JSON/JSONL)
      │
      ▼
backend/powerkit3000.consoleapp ──► AppDb (Postgres)
      │                                 │
      ▼                                 ▼
backend/powerkit3000.core ─────────► backend/powerkit3000.api ──► frontend/tradeforge-suite
```

- CLI 负责离线/批量导入与基本运维操作。
- Core 层沉淀可复用的领域逻辑（导入、查询、统计）。
- API 层将查询与分析服务 REST 化，供前端和外部系统调用。
- 前端提供运营与分析界面，支持 API 与 Mock 数据双轨运行。

## 2. 组件说明
### 2.1 CLI（`backend/powerkit3000.consoleapp`）
- 基于 Spectre.Console 构建命令体系；入口位于 `Program.cs`，命令实现置于 `Commands/` 目录。
- 核心命令：
  - `import <path>`：调用 `KickstarterDataImportService` 批量导入数据，包含批次去重、关联实体处理及日志输出。
  - `split <path> --count <n>`：拆分大文件，便于并行导入或迭代开发。
  - `query`：按多维条件查询并打印结果列表与统计摘要。
  - `counts`/`clear-db`：分别用于数据量统计与数据库清理。
  - `translate`：批量扫描缺失中文名称/简介的项目，调用翻译服务写回 `NameCn`、`BlurbCn` 字段，可配置批次、限额与 dry-run。
- 命令统一通过 `Program.RunAppAsync` 注入测试替换的 ServiceCollection，实现可测试性（见 `backend/powerkit3000.consoleapp.Tests/consoleappTests.cs`）。

### 2.2 领域服务（`backend/powerkit3000.core`）
- `KickstarterDataImportService`：解析 JSON，构建实体图，分批写入数据库，处理重复实体与异常日志。
- `KickstarterProjectQueryService`：封装查询、统计、趋势分析等方法，支持 CancellationToken，供 CLI/API 共享。
- `translations/` 模块提供 `TranslationService` 与多 Provider 接口（OpenAI、Gemini、DeepSeek、NoOp），支持批量请求、重试与内存级缓存。
- `contracts/` 定义查询参数、结果 DTO，确保上下游强类型交互，项目详情包含中英文本。

### 2.3 数据层（`backend/powerkit3000.data`）
- `AppDbContext` 管理 `KickstarterProject`, `Creator`, `Category`, `Location` 等实体。
- 迁移管理通过 `dotnet ef` 完成；`AddChineseFieldsToKickstarterProject` 迁移新增 `NameCn`、`BlurbCn`。
- 建议在 Postgres 上增加索引：`state`, `country`, `category_id`, `launched_at`, `percent_funded`，根据实际数据量优化。

### 2.4 分析 API（`backend/powerkit3000.api`）
- 采用 .NET Minimal API，运行时注册 DbContext 与 QueryService，并启用 Swagger/OpenAPI。
- 主要端点：
  - `GET /projects`：项目列表 + 统计。
  - `GET /filters`：状态、国家、品类选项。
  - `GET /projects/summary`：项目数量、成功数量、总筹资、覆盖国家等。
  - `GET /analytics/categories|countries|creators|top-projects|monthly-trend|funding-distribution`：多维度分析。
  - `GET /analytics/hype`：按筹资速度排序的爆款潜力榜，支持 `minPercentFunded`、`limit`。
  - `GET /analytics/category-keywords`：成品类成功项目关键词云，返回词频、项目覆盖数、平均达成率。
- 列表与高光项目返回 `NameCn`、`BlurbCn` 字段，前端可直接展示中文。
- 所有项目数据附带 `FundingVelocity`（金额/已进行天数），便于识别短期高热项目。
- 默认端口 5200，支持通过 `Cors:AllowedOrigins` 配置跨域。
- 已引入健康检查端点(`/health`)与 Serilog 结构化日志；后续计划聚焦认证中间件（Token/API Key）与速率限制。

### 2.5 前端（`frontend/tradeforge-suite`）
- 技术栈：React + TypeScript + Vite + Ant Design，状态管理采用 React Query。
- 服务层 `src/services/*` 提供 API 调用与 Mock 回退逻辑；`VITE_API_BASE_URL` 控制后端地址。
- 页签：
  - `ProjectsPage`：多条件筛选、表格、统计卡、详情抽屉。
  - `Dashboard`（草稿阶段）：筹资趋势、成功率热力图等可视化计划。
- 错误处理：API 调用失败时尝试使用 Mock 数据并提示用户；需在后续迭代加强异常告警与埋点。

### 2.6 翻译服务架构
- 通过 `TranslationOptions` 读取默认 Provider、目标语言、批量大小、重试次数及各 Provider 凭据。
- `ITranslationProvider` 实现负责实际 API 对接，支持按需扩展；默认提供 OpenAI、Gemini、DeepSeek、NoOp 实现（后两者待补充具体调用）。
- `TranslationService` 处理去重、缓存与退避重试策略，调用失败会记录日志并重试，超出阈值后返回失败状态。
- CLI `translate` 命令基于分页扫描数据库，支持 dry-run 预览、不落库模式以验证翻译质量。

## 3. 数据流与处理逻辑
1. CLI 读取 JSON/JSONL，构建 `KickstarterProject` 对象集合。
2. 导入服务按批次去重并写入数据库，记录重复/失败项。
3. 查询服务使用 LINQ 及 EF Core 聚合，生成列表与统计数据。
4. API 将查询结果转换为 DTO，通过 REST 返回。
5. 前端调用 API，展示列表、指标卡与后续可视化图表。

## 4. 配置与部署
- **数据库连接**：`ConnectionStrings:AppDb`，可被环境变量 `ConnectionStrings__AppDb` 覆盖；不同组件共用配置。
- **迁移执行**：在 `backend/powerkit3000.data` 运行 `dotnet ef database update`；添加迁移时使用 `dotnet ef migrations add <Name>`。
- **脚本**：`scripts/run-console.sh` 自动执行 restore + run；可接入 CI/CD。
- **环境区分**：建议使用 `.env` 或 User Secrets 按环境存储连接串与 CORS 配置。
- **翻译配置**：`Translation` 节点通过环境变量覆盖（例如 `Translation__Providers__openai__ApiKey`）；未配置时默认 `noop` 返回原文。
- **部署建议**：
  - 后端：Docker 镜像或系统服务托管，配置健康检查与日志收集。
  - 前端：Vite 构建后静态部署（如 Nginx/S3 + CloudFront），通过环境变量注入 API 地址。

## 5. 监控与运维（规划）
- 导入命令：输出结构化日志（JSON），记录批次、文件名、成功/失败数量；建议推送至集中日志平台。
- API：集成 ASP.NET Core 健康检查、请求日志与 APM（如 Application Insights）。
- 数据：每日导入成功率、项目总量、异常记录需纳入监控仪表盘。
- 翻译：记录调用成功率、失败原因、平均耗时及配额使用，必要时告警；建议缓存已翻译文本以降低成本。

## 6. 测试策略
- 单元测试：`backend/powerkit3000.consoleapp.Tests` 使用内存数据库验证 CLI 行为；后续需为 QueryService 与 API 补充测试。
- 集成测试：计划引入 WebApplicationFactory 验证 API 契约；前端可采用 Playwright/Cypress 进行冒烟测试。
- 数据校验：导入前可加入 Schema 校验或 JSON Schema 校正。

## 7. 安全与合规
- 短期内依赖内部网络；上线前需实现身份认证、访问审计与敏感字段脱敏。
- Kickstarter 数据使用许可需评估，必要时对导出的报表进行脱敏处理。

## 8. 文档与协作
- 技术变更同步更新本文件及 README 快速上手章节。
- 需求与进度变化写入 `docs/需求文档.md`、`docs/工程进度.md`，确保跨职能对齐。
- 建议建立“需求 → 方案 → 开发 → 验收”清单模板，迭代结束前核对是否补齐测试、文档与部署说明。

本方案将随迭代持续更新，若新增组件或外部依赖，请在对应章节补充。EOF
